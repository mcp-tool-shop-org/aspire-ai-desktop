<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:ScalarScope.Views.Controls"
             xmlns:vm="clr-namespace:ScalarScope.ViewModels"
             x:Class="ScalarScope.Views.TrajectoryPage"
             x:DataType="vm:VortexSessionViewModel"
             Title="Trajectory"
             BackgroundColor="#0f0f1a">

    <Grid RowDefinitions="*,Auto,Auto,Auto" ColumnDefinitions="*,Auto">
        <!-- Main Canvas with Annotation Overlay -->
        <Grid Grid.Row="0" Grid.Column="0">
            <controls:TrajectoryCanvas x:Name="trajectoryCanvas"
                                       Session="{Binding .}"
                                       ShowVelocity="{Binding ShowVelocity, Source={x:Reference velocitySwitch}}"
                                       ShowCurvature="{Binding ShowCurvature, Source={x:Reference curvatureSwitch}}"
                                       ShowProfessors="{Binding ShowProfessors, Source={x:Reference professorsSwitch}}"/>

            <!-- Annotation Overlay (layered on top) -->
            <controls:AnnotationOverlay x:Name="annotationOverlay"
                                        Run="{Binding Run}"
                                        CurrentTime="{Binding Player.Time}"
                                        ShowPhases="{Binding ShowPhases, Source={x:Reference annotationPanel}}"
                                        ShowCurvatureWarnings="{Binding ShowCurvatureWarnings, Source={x:Reference annotationPanel}}"
                                        ShowEigenInsights="{Binding ShowEigenInsights, Source={x:Reference annotationPanel}}"
                                        ShowFailureMarkers="{Binding ShowFailureMarkers, Source={x:Reference annotationPanel}}"
                                        IsVisible="{Binding IsToggled, Source={x:Reference annotationsSwitch}}"/>

            <!-- First-Run Hint (centered, dismissible) -->
            <controls:InlineHint x:Name="playbackHint"
                                 HintId="trajectory_playback"
                                 HintText="Press Space to play, or drag the timeline to scrub through training"
                                 AccentColor="#00d9ff"
                                 HorizontalOptions="Center"
                                 VerticalOptions="End"
                                 Margin="0,0,0,20"
                                 IsVisible="{Binding HasRun}"/>
        </Grid>

        <!-- Annotation Panel (collapsible sidebar) -->
        <controls:AnnotationPanel x:Name="annotationPanel"
                                  Grid.Row="0"
                                  Grid.Column="1"
                                  WidthRequest="200"
                                  Margin="5"
                                  VerticalOptions="Start"
                                  IsVisible="{Binding IsToggled, Source={x:Reference annotationsSwitch}}"/>

        <!-- Toggle Panel with Insight Tooltips -->
        <HorizontalStackLayout Grid.Row="1"
                               Grid.ColumnSpan="2"
                               Spacing="25"
                               Padding="15,8"
                               BackgroundColor="#1a1a2e">
            <!-- Velocity Toggle -->
            <VerticalStackLayout Spacing="1">
                <HorizontalStackLayout Spacing="5">
                    <Label Text="Velocity" TextColor="#4ecdc4" VerticalOptions="Center" FontAttributes="Bold"/>
                    <Switch x:Name="velocitySwitch" IsToggled="True" OnColor="#4ecdc4"/>
                </HorizontalStackLayout>
                <Label Text="Rate of internal state change" TextColor="#666" FontSize="10"/>
            </VerticalStackLayout>

            <!-- Curvature Toggle -->
            <VerticalStackLayout Spacing="1">
                <HorizontalStackLayout Spacing="5">
                    <Label Text="Curvature" TextColor="#ff9f43" VerticalOptions="Center" FontAttributes="Bold"/>
                    <Switch x:Name="curvatureSwitch" IsToggled="True" OnColor="#ff9f43"/>
                </HorizontalStackLayout>
                <Label Text="Phase transitions &amp; revisions" TextColor="#666" FontSize="10"/>
            </VerticalStackLayout>

            <!-- Professors Toggle -->
            <VerticalStackLayout Spacing="1">
                <HorizontalStackLayout Spacing="5">
                    <Label Text="Professors" TextColor="#a29bfe" VerticalOptions="Center" FontAttributes="Bold"/>
                    <Switch x:Name="professorsSwitch" IsToggled="True" OnColor="#a29bfe"/>
                </HorizontalStackLayout>
                <Label Text="Evaluator alignment vectors" TextColor="#666" FontSize="10"/>
            </VerticalStackLayout>

            <BoxView WidthRequest="1" Color="#2a2a4e" Margin="5,0"/>

            <!-- Annotations Toggle -->
            <VerticalStackLayout Spacing="1">
                <HorizontalStackLayout Spacing="5">
                    <Label Text="Annotations" TextColor="#ffd93d" VerticalOptions="Center" FontAttributes="Bold"/>
                    <Switch x:Name="annotationsSwitch" IsToggled="False" OnColor="#ffd93d"/>
                </HorizontalStackLayout>
                <Label Text="Interpretive overlays" TextColor="#666" FontSize="10"/>
            </VerticalStackLayout>

            <BoxView WidthRequest="1" Color="#2a2a4e" Margin="5,0"/>

            <!-- Zoom Controls -->
            <VerticalStackLayout Spacing="1">
                <HorizontalStackLayout Spacing="5">
                    <Label Text="View" TextColor="#00d9ff" VerticalOptions="Center" FontAttributes="Bold"/>
                    <Button x:Name="resetViewButton"
                            Text="âŸ² Reset"
                            Clicked="OnResetViewClicked"
                            BackgroundColor="#2a2a4e"
                            TextColor="#00d9ff"
                            FontSize="11"
                            HeightRequest="28"
                            Padding="8,0"
                            CornerRadius="4"/>
                </HorizontalStackLayout>
                <Label Text="Scroll to zoom, hover for values" TextColor="#666" FontSize="10"/>
            </VerticalStackLayout>
        </HorizontalStackLayout>

        <!-- Toggle Hint -->
        <controls:InlineHint Grid.Row="2"
                             Grid.ColumnSpan="2"
                             HintId="trajectory_toggles"
                             HintText="Toggle Curvature to see phase transitions, or enable Annotations for deeper insights"
                             AccentColor="#ff9f43"
                             Margin="15,5"/>

        <!-- Playback Control -->
        <controls:PlaybackControl Grid.Row="3"
                                  Grid.ColumnSpan="2"
                                  BindingContext="{Binding Player}"/>
    </Grid>
</ContentPage>
