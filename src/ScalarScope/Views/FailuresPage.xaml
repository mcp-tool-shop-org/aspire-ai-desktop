<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:controls="clr-namespace:ScalarScope.Views.Controls"
             xmlns:vm="clr-namespace:ScalarScope.ViewModels"
             xmlns:models="clr-namespace:ScalarScope.Models"
             x:Class="ScalarScope.Views.FailuresPage"
             x:DataType="vm:VortexSessionViewModel"
             Title="Failures"
             BackgroundColor="#0f0f1a">

    <Grid RowDefinitions="Auto,150,*,Auto">
        <!-- Header -->
        <Grid Grid.Row="0"
              Padding="15,10"
              BackgroundColor="#1a1a2e"
              ColumnDefinitions="*,Auto">
            <VerticalStackLayout>
                <Label Text="Failure Analysis"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="White"/>
                <Label Text="{Binding FailureCount, StringFormat='{0} failures detected during training'}"
                       TextColor="#888"
                       FontSize="12"/>
            </VerticalStackLayout>

            <HorizontalStackLayout Grid.Column="1" Spacing="15" VerticalOptions="Center">
                <Label Text="Filter by severity:"
                       TextColor="#888"
                       FontSize="11"
                       VerticalOptions="Center"/>
                <Picker x:Name="severityFilter"
                        SelectedIndex="0"
                        TextColor="White"
                        BackgroundColor="#2a2a4e"
                        WidthRequest="100">
                    <Picker.ItemsSource>
                        <x:Array Type="{x:Type x:String}">
                            <x:String>All</x:String>
                            <x:String>Critical</x:String>
                            <x:String>Warning</x:String>
                            <x:String>Info</x:String>
                        </x:Array>
                    </Picker.ItemsSource>
                </Picker>
            </HorizontalStackLayout>
        </Grid>

        <!-- Timeline Visualization -->
        <controls:FailuresTimeline Grid.Row="1"
                                   x:Name="failuresTimeline"
                                   Failures="{Binding Run.Failures}"
                                   CurrentTime="{Binding Player.Time}"
                                   Margin="10"/>

        <!-- Failures List -->
        <CollectionView Grid.Row="2"
                        x:Name="failuresList"
                        ItemsSource="{Binding Run.Failures}"
                        SelectionMode="Single"
                        Margin="10,0">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:FailureEvent">
                    <Frame BackgroundColor="#16213e"
                           BorderColor="#2a2a4e"
                           CornerRadius="8"
                           Padding="15"
                           Margin="0,5">
                        <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                            <!-- Severity Indicator -->
                            <BoxView Grid.RowSpan="2"
                                     x:Name="severityIndicator"
                                     WidthRequest="4"
                                     CornerRadius="2"
                                     VerticalOptions="Fill"
                                     Margin="0,0,12,0"/>

                            <!-- Category & Time -->
                            <HorizontalStackLayout Grid.Column="1" Spacing="10">
                                <Label Text="{Binding Category}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="White"/>
                                <Border x:Name="severityBadge"
                                        StrokeThickness="0"
                                        Padding="6,2"
                                        StrokeShape="RoundRectangle 3">
                                    <Label Text="{Binding Severity}"
                                           FontSize="10"
                                           TextColor="White"/>
                                </Border>
                            </HorizontalStackLayout>

                            <Label Grid.Column="2"
                                   Text="{Binding T, StringFormat='t={0:P0}'}"
                                   FontSize="12"
                                   TextColor="#888"/>

                            <!-- Description -->
                            <Label Grid.Row="1"
                                   Grid.Column="1"
                                   Grid.ColumnSpan="2"
                                   Text="{Binding Description}"
                                   FontSize="12"
                                   TextColor="#aaa"
                                   LineBreakMode="WordWrap"
                                   Margin="0,5,0,0"/>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <ContentView>
                    <VerticalStackLayout HorizontalOptions="Center"
                                         VerticalOptions="Center"
                                         Spacing="10">
                        <Label Text="No Failures Detected"
                               FontSize="18"
                               TextColor="#4ecdc4"
                               HorizontalOptions="Center"/>
                        <Label Text="This run completed without any recorded failures."
                               TextColor="#555"
                               HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </ContentView>
            </CollectionView.EmptyView>
        </CollectionView>

        <!-- Playback Control -->
        <controls:PlaybackControl Grid.Row="3"
                                  BindingContext="{Binding Player}"/>
    </Grid>
</ContentPage>
